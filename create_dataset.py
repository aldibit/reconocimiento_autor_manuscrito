from PIL import Image
import os
import pandas as pd

# Output paths
dataset_dir = "dataset"
csv_path = "labels.csv"
os.makedirs(dataset_dir, exist_ok=True)

# Author assignment mapping
author_by_image = {
    "1.png": "author_001",
    "2.png": "author_002",
    "3.png": "author_003",
    "4.png": "author_004",
    "5.png": "author_005",
}

# Ensure author subdirectories exist
for author in author_by_image.values():
    os.makedirs(os.path.join(dataset_dir, author), exist_ok=True)

# Coordinates (x1, y1, x2, y2) for each image
boxes_by_image = {
    "1.png": [
    (99.33115505915111, 211.63840878103883, 1205.681432565314, 336.91267851978364),
    (94.49993113991013, 530.1616352894193, 1210.512656484555, 660.6046811089232),
    (94.49993113991013, 850.1911900400769, 1210.512656484555, 979.4654597788217),
    (94.49993113991013, 1177.545640467698, 1196.018984726832, 1312.8199102064427),
    (94.49993113991013, 1492.7439712991145, 1191.187760807591, 1626.8494649571003),
    (99.33115505915111, 1815.267197807495, 1200.850208646073, 1945.7102436269988),
    (94.49993113991013, 2138.959200396634, 1196.018984726832, 2283.8959179738604),
    (94.49993113991013, 2457.8199790665326, 1200.850208646073, 2607.587920563),
    (94.49993113991013, 2781.5119816556717, 1196.018984726832, 2926.4486992328984),
    (94.49993113991013, 3105.203984244811, 1186.35653688835, 3240.478253983556),
    (1307.1371348693729, 206.46963270027982, 2403.8249645370543, 346.5751263582656),
    (1316.7995827078548, 534.9928592086599, 2408.6561884562943, 670.2671289474047),
    (1311.9683587886138, 853.8536378785584, 2394.1625166985723, 979.4654597788217),
    (1307.1371348693729, 1174.883192629216, 2389.3312927793313, 1312.8199102064427),
    (1307.1371348693729, 1491.5751952183555, 2398.9937406178133, 1626.8494649571003),
    (1297.474687030891, 1829.7608695652175, 2394.1625166985723, 1960.2039153847213),
    (1302.3059109501319, 2148.6216482351156, 2403.8249645370543, 2279.06469405462),
    (1297.474687030891, 2462.6512029857736, 2398.9937406178133, 2607.587920563),
    (1297.474687030891, 2791.1744294941536, 2394.1625166985723, 2936.1111470713804),
    (1302.3059109501319, 3114.866432083293, 2394.1625166985723, 3254.971925741279)
    ],
    "2.png": [
    (89.66870722066915, 205.8071848617983, 1205.681432565314, 345.7439024390246),
    (84.83748330142816, 528.3304113701784, 1191.187760807591, 660.6046811089232),
    (94.49993113991013, 858.6848617977994, 1196.018984726832, 984.2966836980622),
    (94.49993113991013, 1177.545640467698, 1196.018984726832, 1303.1574623679608),
    (94.49993113991013, 1496.4064191375965, 1191.187760807591, 1626.8494649571003),
    (94.49993113991013, 1824.9296456459765, 1191.187760807591, 1950.5414675462398),
    (104.1623789783921, 2143.790424315875, 1191.187760807591, 2274.233470135379),
    (99.33115505915111, 2467.482426905014, 1191.187760807591, 2602.756696643759),
    (99.33115505915111, 2791.1744294941536, 1191.187760807591, 2911.955027475176),
    (104.1623789783921, 3110.035208164052, 1191.187760807591, 3235.647030064315),
    (1307.1371348693729, 216.13208053876178, 2389.3312927793313, 336.91267851978364),
    (1302.3059109501319, 534.9928592086599, 2389.3312927793313, 650.9422332704412),
    (1302.3059109501319, 853.8536378785584, 2394.1625166985723, 979.4654597788217),
    (1302.3059109501319, 1177.545640467698, 2389.3312927793313, 1293.4950145294792),
    (1302.3059109501319, 1496.4064191375965, 2384.5000688600903, 1626.8494649571003),
    (1311.9683587886138, 1820.0984217267355, 2394.1625166985723, 1940.8790197077578),
    (1307.1371348693729, 2143.790424315875, 2389.3312927793313, 2269.4022462161383),
    (1311.9683587886138, 2467.482426905014, 2384.5000688600903, 2588.2630248860364),
    (1307.1371348693729, 2786.3432055749126, 2389.3312927793313, 2916.7862513944165),
    (1307.1371348693729, 3114.866432083293, 2389.3312927793313, 3240.478253983556)
    ],
    "3.png": [
    (109.81586811915577, 220.9001735274278, 1215.8507664128028, 346.47618818085493),
    (109.81586811915577, 554.1595970307535, 1206.1910729779238, 670.0759182493016),
    (114.64571483659529, 882.5891738166397, 1206.1910729779238, 998.5054950351878),
    (109.81586811915577, 1206.1889038850868, 1215.8507664128028, 1326.9350718210744),
    (109.81586811915577, 1529.7886339535335, 1201.3612262604847, 1655.3646486069606),
    (119.47556155403481, 1872.7077508917382, 1211.0209196953638, 1983.794225392847),
    (119.47556155403481, 2196.307480960185, 1215.8507664128028, 2312.2238021787334),
    (119.47556155403481, 2515.0773643111925, 1211.0209196953638, 2645.6533789646196),
    (119.47556155403481, 2848.336787814518, 1211.0209196953638, 2969.082955750506),
    (119.47556155403481, 3171.9365178829653, 1220.6806131302428, 3297.5125325363924),
    (1326.9372409139114, 220.9001735274278, 2423.31244577268, 341.6463414634154),
    (1326.9372409139114, 558.989443748193, 2423.31244577268, 674.9057649667411),
    (1322.1073941964723, 868.0996336643211, 2418.482599055241, 998.5054950351878),
    (1322.1073941964723, 1196.5292104502078, 2423.31244577268, 1330.9350718210744),
    (1336.5969343487905, 1529.7886339535335, 2418.482599055241, 1660.1944953244001),
    (1331.7670876313514, 1867.8779041742987, 2428.14229249012, 1978.9643786754075),
    (1331.7670876313514, 2191.477634242746, 2432.972139207559, 2318.2238021787334),
    (1326.9372409139114, 2515.0773643111925, 2423.31244577268, 2640.82353224718),
    (1331.7670876313514, 2838.677094379639, 2423.31244577268, 2974.082955750506),
    (1341.4267810662304, 3167.1066711655258, 2432.972139207559, 3297.5125325363924)
    ],
    "4.png": [
    (99.33115505915111, 220.9633044580023, 1191.187760807591, 336.91267851978364),
    (94.49993113991013, 539.8240831279008, 1186.35653688835, 655.7734571896822),
    (94.49993113991013, 853.8536378785584, 1191.187760807591, 974.6342358595807),
    (99.33115505915111, 1187.2080883061794, 1186.35653688835, 1305.4950145294792),
    (104.1623789783921, 1506.068866976078, 1181.52531296911, 1617.1870171186183),
    (104.1623789783921, 1824.9296456459765, 1196.018984726832, 1945.7102436269988),
    (104.1623789783921, 2148.6216482351156, 1191.187760807591, 2269.4022462161383),
    (104.1623789783921, 2462.6512029857736, 1196.018984726832, 2593.431800966796),
    (113.82482681687361, 2805.6681012518766, 1186.35653688835, 2921.6174753136575),
    (108.99360289763263, 3124.5288799217747, 1186.35653688835, 3240.478253983556),
    (1302.3059109501319, 220.9633044580023, 2384.5000688600903, 332.08145460054266),
    (1302.3059109501319, 534.9928592086599, 2374.8376210216084, 646.1110093512007),
    (1311.9683587886138, 853.8536378785584, 2384.5000688600903, 980.8030119403397),
    (1302.3059109501319, 1172.714416548457, 2389.3312927793313, 1298.3262384487202),
    (1302.3059109501319, 1501.2376430568374, 2389.3312927793313, 1622.0182410378593),
    (1307.1371348693729, 1820.0984217267355, 2394.1625166985723, 1945.7102436269988),
    (1307.1371348693729, 2143.790424315875, 2394.1625166985723, 2270.5710222968974),
    (1311.9683587886138, 2462.6512029857736, 2398.9937406178133, 2588.2630248860364),
    (1316.7995827078548, 2786.3432055749126, 2398.9937406178133, 2916.7862513944165),
    (1316.7995827078548, 3114.866432083293, 2394.1625166985723, 3235.647030064315)
    ],
    "5.png": [
    (89.66870722066915, 201.63840878103883, 1181.52531296911, 332.08145460054266),
    (89.66870722066915, 523.1616352894193, 1191.187760807591, 650.9422332704412),
    (89.66870722066915, 849.0224139593179, 1186.35653688835, 974.6342358595807),
    (94.49993113991013, 1167.883192629216, 1186.35653688835, 1298.3262384487202),
    (99.33115505915111, 1496.4064191375965, 1191.187760807591, 1626.8494649571003),
    (99.33115505915111, 1815.267197807495, 1191.187760807591, 1936.0477957885169),
    (99.33115505915111, 2129.2967525581525, 1200.850208646073, 2269.4022462161383),
    (99.33115505915111, 2452.9887551472916, 1196.018984726832, 2593.0942488052774),
    (99.33115505915111, 2776.680757736431, 1196.018984726832, 2907.123803555935),
    (104.1623789783921, 3105.203984244811, 1196.018984726832, 3235.647030064315),
    (1297.474687030891, 191.97596094255732, 2384.5000688600903, 312.7565589235792),
    (1297.474687030891, 520.4991874509374, 2389.3312927793313, 650.9422332704412),
    (1302.3059109501319, 839.3599661208359, 2379.6688449408493, 974.6342358595807),
    (1297.474687030891, 1163.0519687099754, 2389.3312927793313, 1288.6637906102383),
    (1302.3059109501319, 1481.9127473798735, 2389.3312927793313, 1617.1870171186183),
    (1302.3059109501319, 1805.604749969013, 2389.3312927793313, 1940.8790197077578),
    (1307.1371348693729, 2134.1279764773935, 2389.3312927793313, 2254.9085744584154),
    (1307.1371348693729, 2452.9887551472916, 2394.1625166985723, 2588.2630248860364),
    (1311.9683587886138, 2776.5119816556717, 2384.5000688600903, 2911.955027475176),
    (1307.1371348693729, 3100.37276032557, 2389.3312927793313, 3230.815806145074)
    ]
}

# Process and save images and metadata
records = []
for image_file, boxes in boxes_by_image.items():
    img = Image.open(image_file)
    person_id = os.path.splitext(image_file)[0].zfill(4)
    base_name = f"img_{person_id}"
    author = author_by_image[image_file]
    author_dir = os.path.join(dataset_dir, author)

    for i, (x1, y1, x2, y2) in enumerate(boxes, 1):
        filename = f"{base_name}_box{i:02d}.png"
        crop = img.crop((x1, y1, x2, y2))
        crop.save(os.path.join(author_dir, filename))
        records.append({
            "filename": filename,
            "person_id": base_name,
            "expression_index": i,
            "transcription": "",
            "author": author
        })

# Save CSV
pd.DataFrame(records).to_csv(csv_path, index=False)
print("âœ… Dataset created. All images loaded, processed and cropped.")
